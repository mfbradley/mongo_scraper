<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="UTC-8">
    <title>Saved Articles</title>


    <!--Bootstrap Link-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous">

    <!-- style.css Link -->
    <link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>
    <div id="container">
        
        <!-- NavBar -->
        <!-- Includes links to Home page, Saved Articles Page, and a 'Scrape for New Articles' button -->
        <ul class="nav">
            <li class="nav-item">
                <a class="navbar-brand" href="#">Mongo Scraper</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="index.html">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Saved Articles</a>
            </li>
            <li class="nav-item">
                <button id="scraperButton" class="btn btn-secondary" type="submit">Scrape for New Articles</button>
            </li>
        </ul>

        <!-- Jumbotron -->
        <div class="jumbotron jumbotron-fluid">
            <div class="container">
                <h1 class="display-4">Mongo Scraper</h1>
                <p class="lead">Saved Articles</p>
            </div>
        </div>
    </div>

    <!-- Empty div to populate saved articles -->
    <div id="savedArticlesDiv" class="container-fluid">

    </div>

    <!-- Modal -->
    <!-- Pop up to create and view saved Notes -->
    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="exampleModalLongTitle"></h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                
                <div id="notesDiv" class="modal-body">
                    <h5>Saved Notes: </h5>
                    <div id="savedNotes">
                        
                    </div>
                    <hr>
                    <h5>Create New Note: </h5>
                    <div class="row noteTitle">

                    </div>
                    <div class="row noteBody">

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>

                </div>
            </div>
        </div>
    </div>



    <!--Bootstrap Scripts-->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js" integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4" crossorigin="anonymous"></script>

    <!-- jQuery script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    
    <!-- app.js script -->
    <script src="app.js"></script>
    
    <!-- Scripts related to savedArticles.html only -->
    <script>
        // get saved articles and populate the page
        $.getJSON("/articles/saved", function(data) {
            // For each one
            for (let i = 0; i < data.length; i++) {
                // Display the apropos information on the page
                $("#savedArticlesDiv").append(
                    "<div class='card text-white bg-info mb-3'><div class='card-header'>" +
                    "<h3 class='title' data-id='" + data[i]._id +
                    "' href='" + data[i].link + "'>" +
                    data[i].title + "</h3>" +
                    "<br />" +
                    "<div class='card-body bg-light mb-3'>" +
                    "<p class='card-text'>" + data[i].summary +
                    "</p>" +

                    '<button type="button" data-id="' + data[i]._id +
                    '" class="btn btn-secondary articleNotes" data-toggle="modal" data-target="#exampleModalCenter">Article Notes</button><vr> ' +
                    '<button href="#" data-id="' + data[i]._id +
                    '" class="btn btn-secondary deleteSave">Delete from Saved</button></div></div>'
                );
            }
        });

        // click handler for 'Aticle Notes' button 
        $(document).on("click", "button.articleNotes", function() {
            // Save the id from the button tag
            var thisId = $(this).attr("data-id");
            console.log(thisId);

            // Now make an ajax call for the Article
            $.ajax({
                    method: "GET",
                    url: "/articles/" + thisId
                })
                // With that done, add the note information to the page
                .done(function(data) {
                    console.log(data);
                    // The title of the article
                    $(".modal-title").append("<h2>" + data[0].title + "</h2>");
                    // An input to enter a new title
                    $(".noteTitle").append("<input id='titleinput' name='title' placeholder='Note Title'>");
                    // A textarea to add a new note body
                    $(".noteBody").append("<textarea id='bodyinput' name='body' placeholder='Notes'></textarea>");
                    // A button to submit a new note, with the id of the article saved to it
                    $(".modal-footer").append("<button type='button' class='btn btn-secondary saveNote' data-id='" + data[0]._id + "' data-dismiss='modal'>Save Note</button>");

                    // // If there's a note in the article
                    if (data[0].notes) {
                        console.log("notes exist!");
                        
                        for(var i = 0; i < data[0].notes.length; i++) {
                            $("#savedNotes").append(
                                "<p>" + data[0].notes[i].title + ": " + data[0].notes[i].body + "</p>"
                            );
                        }
                   
                    }
                });
        });

        // When you click the savenote button
        $(document).on("click", "button.saveNote", function() {
            // Grab the id associated with the article from the submit button and post to articles/id route
            var id = $(this).attr("data-id");
            // window.location.reload();
            window.location.reload();

            $.ajax({
                    method: "POST",
                    url: "/articles/" + id,
                    data: {
                        // Value taken from title input
                        title: $("#titleinput").val(),
                        // Value taken from note textarea
                        body: $("#bodyinput").val()
                    }
                })
                // With that done
                .done(function(data) {
                    // Log the response
                    console.log(data);
                });
        });


        $(document).on("click", "button.deleteSave", function() {
            var id = $(this).attr("data-id");
            console.log(id);
            window.location.reload();

            $.ajax({
                    method: "PUT",
                    url: "articles/deleted/" + id,
                    data: {
                        saved: false
                    }
                })
                .done(function(data) {
                    console.log(data);
                });
        });
    </script>
</body>

</html>
